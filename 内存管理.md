# 内存管理

处理器中的MMU实现VA到PA的转换，TTBR保存了页表基地址

地址总线默认48位，但是发出的地址请求是64位的，所以可以根据高16位将虚拟地址VA划分成2个空间：

- 高16位为1：内核空间 TTBR1
- 高16位为0：用户空间 TTBR0

**CPU根据发出的请求自动选择正确的页表**

四级页表映射

一个页表项8个字节，L0-L2的页表项都是下一级页表的基地址，L3的页表项存的是PPN

**描述符L0-L2   3种**

- 如果bit0是0，代表无效
- 如果bit1是1，代表指向下一级页表
- 如果bit1是1，代表是块类型的，描述很大的一块内存，里面存了一块物理内存的起始地址

**描述符L3    5种**

- bit0为0，无效
- bit1为1，保留页表项
- 根据47位和更低的位，来判断3种页表大小的粒度

**描述符里面的属性：描述这个页面**

内存类型 权限 安全模式 是否修改过 是不是block类型 能不能执行

**属性的字段没有写属性，而是把可以选择的属性，放在MAIR_ELn里面，它分成8个字段，代表不同的属性，在页表项里面的对应属性的地方填上索引代表这里是某个属性**


**内核要填充页表，填入页表基地址**

# TCR

IPS:配置物理地址大小

TG1和TG0：页表粒度大小

T1SZ：配置TTBR1_EL1页表能管辖的大小

T0SZ：配置TTBR0_EL1页表能管辖的大小

# SCTLR_EL1

M：打开和关闭MMU

I：打开指令cache

C：打开数据cache

# 设备内存 MMIO DMA等等

设备内存通常对一致性要求严格

# S2

页表基地址 VTTBR_EL2

控制寄存器 VTCR_EL2

HCR_EL2.VM：开启S2页表映射
